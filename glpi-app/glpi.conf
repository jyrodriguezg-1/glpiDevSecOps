# /etc/nginx/conf.d/glpi.conf
server {
    listen       80 default_server;
    server_name  _;

    root   /var/www/html/glpi;
    index  index.php index.html;
    client_max_body_size 100M;

    # ────────────────────────────────────────────────
    # 1) Rewrite para rutas “bonitas” de la API REST
    #    /apirest/foo → /apirest.php/foo
    # ────────────────────────────────────────────────
    location ^~ /apirest {
        rewrite ^/apirest(/.*)$ /apirest.php$1 last;
    }

    # ────────────────────────────────────────────────
    # 2) Procesamiento de PHP (incluye .php y .php/…)
    #    => pasa TODO a PHP-FPM
    # ────────────────────────────────────────────────
    location ~ [^/]\.php(/|$) {
        # separa SCRIPT_FILENAME de PATH_INFO
        fastcgi_split_path_info ^(.+\.php)(/.*)$;

        # parametros mínimos obligatorios
        include        fastcgi.conf;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        fastcgi_param  PATH_INFO        $fastcgi_path_info;
        fastcgi_param  HTTP_COOKIE      $http_cookie;

        fastcgi_index  index.php;
        fastcgi_pass   127.0.0.1:9000;
    }

    # ────────────────────────────────────────────────
    # 3) Estáticos del instalador
    # ────────────────────────────────────────────────
    location ~* ^/install/(?:css|js|pics)/ {
        expires    1d;
        access_log off;
    }

    # ────────────────────────────────────────────────
    # 4) Fallback del instalador (HTML)
    # ────────────────────────────────────────────────
    location /install/ {
        try_files $uri $uri/ /install/install.php?$query_string;
    }

    # ────────────────────────────────────────────────
    # 5) Estáticos generales (CSS, JS, imágenes…)
    # ────────────────────────────────────────────────
    location ~* \.(?:ico|css|js|gif|jpe?g|png|webp|svg|woff2?)$ {
        expires    30d;
        access_log off;
    }

    # ────────────────────────────────────────────────
    # 6) Resto de rutas → GLPI SPA (index.php)
    # ────────────────────────────────────────────────
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ────────────────────────────────────────────────
    # 7) Denegar accesos a archivos ocultos
    # ────────────────────────────────────────────────
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
