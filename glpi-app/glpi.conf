# glpi-app/glpi.conf
server {
    listen       80 default_server;
    server_name  _;

    root   /var/www/html/glpi;
    index  index.php index.html;

    client_max_body_size 100M;

    # ──────────────────────────────────────────────────
    # 1) Todo lo que esté bajo /install/ → installer
    #    (coge CSS, JS, imágenes… y POSTs al PHP)
    # ──────────────────────────────────────────────────
    location ^~ /install/ {
        try_files $uri $uri/ /install/install.php?$query_string;
    }

    # ──────────────────────────────────────────────────
    # 2) Archivos estáticos del instalador (css, js, pics)
    # ──────────────────────────────────────────────────
    location ~* ^/install/(?:css|js|pics)/ {
        expires    1d;
        access_log off;
    }

    # ──────────────────────────────────────────────────
    # 3) Archivos estáticos generales (ico|css|js|png|jpg|…)
    # ──────────────────────────────────────────────────
    location ~* \.(?:ico|css|js|gif|jpe?g|png|webp|svg|woff2?)$ {
        expires    30d;
        access_log off;
    }

    # ──────────────────────────────────────────────────
    # 4) Resto de rutas → index.php (SPA de GLPI)
    # ──────────────────────────────────────────────────
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # ──────────────────────────────────────────────────
    # 5) Procesar TODOS los .php via PHP-FPM
    #    (incluye POST a /install/install.php)
    # ──────────────────────────────────────────────────
    location ~ \.php$ {
        include         fastcgi_params;                # trae SCRIPT_FILENAME y HTTP_COOKIE
        fastcgi_param   HTTP_COOKIE $http_cookie;      # PASAMOS la cookie de sesión
        fastcgi_param   SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass    127.0.0.1:9000;
        fastcgi_index   index.php;
    }

    # ──────────────────────────────────────────────────
    # 6) Proteger ficheros ocultos (.git, .env…)
    # ──────────────────────────────────────────────────
    location ~ /\.(?!well-known).* {
        deny all;
    }
}
